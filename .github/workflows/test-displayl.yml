name: Test Display

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  check-display-linux:
    name: Linux Display Check
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - ubuntu-24.04
          - ubuntu-22.04
          - ubuntu-24.04-arm
          - ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Check if display is available on Linux
        run: |
          if [ -n "$DISPLAY" ] || [ -n "$WAYLAND_DISPLAY" ]; then
            echo "Display available"
          else
            echo "No display"
          fi

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests in headless mode
        continue-on-error: true
        run: npx playwright test

      - name: Run Playwright tests in headed mode
        continue-on-error: true
        run: xvfb-run npx playwright test --headed

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-linux-${{ matrix.os }}
          path: screenshots/**
          if-no-files-found: warn

  check-display-windows:
    name: Windows Display Check
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
          - windows-2025
          - windows-2022
          - windows-11-arm
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Check active Windows displays
        shell: powershell
        run: |
          $active = Get-WmiObject WmiMonitorID -Namespace root\wmi | Measure-Object | Select-Object -ExpandProperty Count
          Write-Host "Active Display Count: $active"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests in headless mode
        continue-on-error: true
        run: npx playwright test

      - name: Run Playwright tests in headed mode
        continue-on-error: true
        run: npx playwright test --headed

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-windows-${{ matrix.os }}
          path: screenshots/**
          if-no-files-found: warn

  check-display-macos:
    name: macOS Display Check
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
          - macos-26
          - macos-15
          - macos-15-intel
          - macos-14
          - macos-13
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Check if display is available on macOS
        run: |
          count=$(system_profiler SPDisplaysDataType | grep "Resolution" | wc -l)
          echo "Active Display Count: $count"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests in headless mode
        continue-on-error: true
        run: npx playwright test

      - name: Run Playwright tests in headed mode
        continue-on-error: true
        run: npx playwright test --headed

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-macos-${{ matrix.os }}
          path: screenshots/**
          if-no-files-found: warn

  merge-artifacts:
    name: Merge All Screenshots
    needs: [check-display-linux, check-display-windows, check-display-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-screenshots
          pattern: screenshots-*
          merge-multiple: true

      - name: Upload merged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-playwright-screenshots
          path: all-screenshots/**
          if-no-files-found: warn
